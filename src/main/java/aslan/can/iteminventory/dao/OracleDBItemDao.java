package aslan.can.iteminventory.dao;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.UUID;
import aslan.can.iteminventory.model.Item;
import org.springframework.stereotype.Repository;
import java.sql.*;

@Repository("oracle-item")
public class OracleDBItemDao implements ItemDao {

    public static Connection dbConnection;

    public static void establishConnection() {
        try {
            Class.forName("oracle.jdbc.driver.OracleDriver");
            dbConnection = DriverManager.getConnection(
                "jdbc:oracle:thin:@localhost:1527/xepdb1",
                AppProperties.OracleUsername,
                AppProperties.OraclePassword);

            try {
                PreparedStatement tableAccessStatement = dbConnection.prepareStatement(
                    "SELECT * FROM items");
                tableAccessStatement.executeQuery();
            }
            catch (SQLSyntaxErrorException e) {
                e.printStackTrace();
                PreparedStatement createTableStatement = dbConnection.prepareStatement(
                    "CREATE TABLE items(task_id NUMBER GENERATED BY DEFAULT AS IDENTITY, owner_uuid VARCHAR2(63), task_title VARCHAR2(63), task_desc VARCHAR2(255), task_category VARCHAR2(63), PRIMARY KEY(task_id))");
                    createTableStatement.executeQuery();
            }
        }
        catch (Exception e) {
            e.printStackTrace();
        }
    }

    @Override
    public int insertItem(UUID ownerUUID, Item item) {
        try {
            PreparedStatement insertStatement = dbConnection.prepareStatement(
                "INSERT INTO items(owner_uuid, task_title, task_desc, task_category) VALUES('"
                + ownerUUID + "', '"
                + item.getTitle() + "', '"
                + item.getDesc() + "', '"
                + item.getCategory() + "')");
            insertStatement.executeQuery();
            insertItemDebug(ownerUUID, item.getTitle(), item.getDesc(), item.getCategory());
            return 1;
        }
        catch (Exception e) {
            e.printStackTrace();
            return 0;
        }
    }

    @Override
    public List<Item> getAllItems() {
        ArrayList<Item> allItems = new ArrayList<Item>();

        try {
            PreparedStatement getAllItemsStatement = dbConnection.prepareStatement(
                "SELECT * FROM items");
            ResultSet result = getAllItemsStatement.executeQuery();

            while ( result.next() ) {
                allItems.add(new Item(  UUID.fromString(result.getString(2)),
                                        result.getString(3),
                                        result.getString(4),
                                        result.getString(5)));
            }
        }
        catch (Exception e) {
            e.printStackTrace();
        }

        return allItems;
    }

    @Override
    public Optional<Item> getItemsOfUserByID(UUID itemID) {
        // TODO Auto-generated method stub
        return Optional.empty();
    }

    @Override
    public int deleteItemByID(UUID itemID) {
        // TODO Auto-generated method stub (ADD ITEM UUID LATER FOR THIS AND UPDATEITEMBYID)
        return 0;
    }
    
    private void insertItemDebug(UUID ownerUUID, String title, String desc, String category) {
        System.out.println("------ITEM ADDED-------");
        System.out.println("OwnerUUID: " + ownerUUID);
        System.out.println("Title: " + title);
        System.out.println("Description: " + desc);
        System.out.println("Category: " + category.toLowerCase());
        System.out.println("------ITEM ADDED-------");
    }
}
